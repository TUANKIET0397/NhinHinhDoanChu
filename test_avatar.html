<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Avatar Manager</title>
    <style>
        .player {
            display: flex;
            align-items: center;
            margin: 10px;
            padding: 10px;
            border: 1px solid #ccc;
        }
        .player_avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .player_avatar[data-avatar="1"] { background-image: url('assets/public/img/avatar/avt1.jpg'); }
        .player_avatar[data-avatar="2"] { background-image: url('assets/public/img/avatar/avt2.jpg'); }
        .player_avatar[data-avatar="3"] { background-image: url('assets/public/img/avatar/avt3.jpg'); }
        .player_avatar[data-avatar="4"] { background-image: url('assets/public/img/avatar/avt4.jpg'); }
        .player_avatar[data-avatar="5"] { background-image: url('assets/public/img/avatar/avt5.jpg'); }
        .player_avatar[data-avatar="6"] { background-image: url('assets/public/img/avatar/avt6.jpg'); }
        .player_avatar[data-avatar="7"] { background-image: url('assets/public/img/avatar/avt7.jpg'); }
        .player_avatar[data-avatar="8"] { background-image: url('assets/public/img/avatar/avt8.jpg'); }
        .player_avatar[data-avatar="9"] { background-image: url('assets/public/img/avatar/avt9.jpg'); }
        .player_avatar[data-avatar="10"] { background-image: url('assets/public/img/avatar/avt10.jpg'); }
        .player_avatar[data-avatar="11"] { background-image: url('assets/public/img/avatar/avt11.jpg'); }
        .player_avatar[data-avatar="12"] { background-image: url('assets/public/img/avatar/avt12.jpg'); }
        .player_avatar[data-avatar="13"] { background-image: url('assets/public/img/avatar/avt13.jpg'); }
        .player_avatar[data-avatar="14"] { background-image: url('assets/public/img/avatar/avt14.jpg'); }
        .player_avatar[data-avatar="15"] { background-image: url('assets/public/img/avatar/avt15.jpg'); }
        .player_avatar[data-avatar="16"] { background-image: url('assets/public/img/avatar/avt16.jpg'); }
        .player_avatar[data-avatar="17"] { background-image: url('assets/public/img/avatar/avt17.jpg'); }
        .player_avatar[data-avatar="18"] { background-image: url('assets/public/img/avatar/avt18.jpg'); }
        .player_avatar[data-avatar="19"] { background-image: url('assets/public/img/avatar/avt19.jpg'); }
        .player_avatar[data-avatar="20"] { background-image: url('assets/public/img/avatar/avt20.jpg'); }
    </style>
</head>
<body>
    <h1>Test Avatar Manager</h1>
    <button onclick="addPlayer()">Add Player</button>
    <button onclick="removePlayer()">Remove Player</button>
    <button onclick="resetAvatars()">Reset Avatars</button>
    <div id="players"></div>

    <script>
        // Avatar Manager
        const avatarManager = {
            usedAvatars: new Map(),
            availableAvatars: Array.from({length: 20}, (_, i) => i + 1),
            
            // Khởi tạo từ localStorage nếu có
            init() {
                const savedAvatars = localStorage.getItem('playerAvatars');
                if (savedAvatars) {
                    try {
                        const parsed = JSON.parse(savedAvatars);
                        this.usedAvatars = new Map(Object.entries(parsed));
                        // Cập nhật danh sách avatar có sẵn
                        this.availableAvatars = Array.from({length: 20}, (_, i) => i + 1)
                            .filter(num => !Array.from(this.usedAvatars.values()).includes(num));
                        console.log('Loaded avatars from localStorage:', this.getAllAssignedAvatars());
                    } catch (error) {
                        console.error('Error loading avatars from localStorage:', error);
                    }
                }
            },
            
            // Lưu avatar vào localStorage
            saveToLocalStorage() {
                try {
                    localStorage.setItem('playerAvatars', JSON.stringify(this.getAllAssignedAvatars()));
                } catch (error) {
                    console.error('Error saving avatars to localStorage:', error);
                }
            },
            
            getRandomAvatar(playerId) {
                // Nếu player đã có avatar, trả về avatar đó
                if (this.usedAvatars.has(playerId)) {
                    const existingAvatar = this.usedAvatars.get(playerId);
                    console.log(`Player ${playerId} already has avatar: ${existingAvatar}`);
                    return existingAvatar;
                }
                
                // Nếu hết avatar, reset lại
                if (this.availableAvatars.length === 0) {
                    console.log('No more available avatars, resetting...');
                    this.resetAvatars();
                }
                
                // Lấy avatar ngẫu nhiên từ danh sách có sẵn
                const randomIndex = Math.floor(Math.random() * this.availableAvatars.length);
                const avatarNumber = this.availableAvatars.splice(randomIndex, 1)[0];
                
                // Lưu avatar cho player này
                this.usedAvatars.set(playerId, avatarNumber);
                
                // Lưu vào localStorage
                this.saveToLocalStorage();
                
                console.log(`Assigned avatar ${avatarNumber} to player ${playerId}`);
                return avatarNumber;
            },
            
            resetAvatars() {
                this.availableAvatars = Array.from({length: 20}, (_, i) => i + 1);
                this.usedAvatars.clear();
                // Xóa localStorage
                localStorage.removeItem('playerAvatars');
                console.log('Avatar manager reset');
            },
            
            getPlayerAvatar(playerId) {
                return this.usedAvatars.get(playerId);
            },
            
            getAllAssignedAvatars() {
                return Object.fromEntries(this.usedAvatars);
            },
            
            removePlayerAvatar(playerId) {
                if (this.usedAvatars.has(playerId)) {
                    const avatarNumber = this.usedAvatars.get(playerId);
                    this.usedAvatars.delete(playerId);
                    // Trả lại avatar vào danh sách có sẵn
                    this.availableAvatars.push(avatarNumber);
                    // Lưu vào localStorage
                    this.saveToLocalStorage();
                    console.log(`Removed avatar ${avatarNumber} from player ${playerId}`);
                }
            }
        };

        let playerCount = 0;
        let players = [];

        function addPlayer() {
            playerCount++;
            const playerId = `player_${playerCount}`;
            const playerName = `Player ${playerCount}`;
            
            players.push({ id: playerId, name: playerName });
            renderPlayers();
        }

        function removePlayer() {
            if (players.length > 0) {
                const removedPlayer = players.pop();
                avatarManager.removePlayerAvatar(removedPlayer.id);
                renderPlayers();
            }
        }

        function resetAvatars() {
            avatarManager.resetAvatars();
            players = [];
            playerCount = 0;
            renderPlayers();
        }

        function renderPlayers() {
            const container = document.getElementById('players');
            container.innerHTML = '';

            players.forEach((p) => {
                const playerDiv = document.createElement('div');
                playerDiv.classList.add('player');

                const avatarNumber = avatarManager.getRandomAvatar(p.id);

                playerDiv.innerHTML = `
                    <div class="player_avatar" data-avatar="${avatarNumber}"></div>
                    <div>
                        <div>${p.name} (${p.id})</div>
                        <div>Avatar: ${avatarNumber}</div>
                    </div>
                `;

                container.appendChild(playerDiv);
            });

            console.log('Current assigned avatars:', avatarManager.getAllAssignedAvatars());
        }

        // Khởi tạo
        avatarManager.init();
    </script>
</body>
</html>
